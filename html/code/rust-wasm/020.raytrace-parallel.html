<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>020.raytrace-parallel 020.raytrace-parallel</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="http://localhost:8000/css/styles_min.css" />
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#parallel-raytracing">Parallel Raytracing</a>
<ul>
<li><a href="#building-the-demo">Building the demo</a></li>
<li><a href="#setup-the-project">setup the project</a></li>
<li><a href="#the-code">The code</a></li>
<li><a href="#running-the-demo">Running the demo</a></li>
</ul></li>
<li><a href="#build-and-serve">build and serve</a></li>
<li><a href="#whats-next">What’s next?</a></li>
</ul>
</nav>
<div class="navbar">
<a class="openbtn" onclick="openNav()">☰</a>
</div>
<p>Previous example: <a href="./019.wasm-in-web-worker.html"><code>&lt;--</code> web-sys: Wasm in Web Worker</a></p>
<main>
<h2 id="parallel-raytracing">Parallel Raytracing</h2>
<p><em>This is an example of using threads with WebAssembly, Rust, and wasm-bindgen, culminating in a parallel raytracer demo. There’s a number of moving pieces to this demo and it’s unfortunately not the easiest thing to wrangle, but it’s hoped that this’ll give you a bit of a taste of what it’s like to use threads and wasm with Rust on the web.</em><br />
_ <a href="https://rustwasm.github.io/wasm-bindgen/examples/raytrace-parallel.html" target="_blank">wasm-bindgen Guide</a></p>
<p><a href="https://github.com/rustwasm/wasm-bindgen/tree/master/examples/raytrace-parallel" target="_blank">Parallel Raytracing</a></p>
<h3 id="building-the-demo">Building the demo</h3>
<p><em>One of the major gotchas with threaded WebAssembly is that Rust does not ship a precompiled target (e.g. standard library) which has threading support enabled. This means that you’ll need to recompile the standard library with the appropriate rustc flags, namely -C target-feature=+atomics,+bulk-memory,+mutable-globals. Note that this requires a nightly Rust toolchain.</em><br />
_ <a href="https://rustwasm.github.io/wasm-bindgen/examples/raytrace-parallel.html" target="_blank">wasm-bindgen Guide</a></p>
<h3 id="setup-the-project">setup the project</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ex">cargo</span> new raytrace-parallel --lib</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="bu">cd</span> raytrace-parallel</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="fu">mkdir</span> -p www/js www/html</span></code></pre></div>
<ul>
<li>Edit Cargo.toml</li>
</ul>
<pre class="toml"><code>[lib]
crate-type = [&quot;cdylib&quot;]

[dependencies]
console_error_panic_hook = &quot;0.1&quot;
js-sys = &quot;0.3.66&quot;
rayon = &quot;1.1.0&quot;
rayon-core = &quot;1.5.0&quot;
raytracer = { git = &#39;https://github.com/alexcrichton/raytracer&#39;, branch = &#39;update-deps&#39; }
serde-wasm-bindgen = &quot;0.4.3&quot;
futures-channel-preview = &quot;0.3.0-alpha.18&quot;
wasm-bindgen = &quot;0.2.89&quot;
wasm-bindgen-futures = &quot;0.4.39&quot;

[dependencies.web-sys]
version = &quot;0.3.23&quot;
features = [
  &#39;CanvasRenderingContext2d&#39;,
  &#39;ErrorEvent&#39;,
  &#39;Event&#39;,
  &#39;ImageData&#39;,
  &#39;Navigator&#39;,
  &#39;Window&#39;,
  &#39;Worker&#39;,
  &#39;DedicatedWorkerGlobalScope&#39;,
  &#39;MessageEvent&#39;,
]


# Replace command line  
# cargo build --target wasm32-unknown-unknown -Z build-std=panic_abort,std
# and 
# export RUSTFLAGS=&#39;-C target-feature=+atomics,+bulk-memory,+mutable-globals&#39;
# with:
[unstable]
build-std = [&#39;std&#39;, &#39;panic_abort&#39;]

[build]
target = &quot;wasm32-unknown-unknown&quot;
rustflags = &#39;-Ctarget-feature=+atomics,+bulk-memory,+mutable-globals&#39;</code></pre>
<h3 id="the-code">The code</h3>
<ul>
<li>index.html</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="dt">&lt;!doctype </span>html<span class="dt">&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>    <span class="kw">&lt;meta</span><span class="ot"> content=</span><span class="st">&quot;text/html;charset=utf-8&quot;</span><span class="ot"> http-equiv=</span><span class="st">&quot;Content-Type&quot;</span><span class="kw">/&gt;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>    <span class="kw">&lt;title&gt;</span>Parallel Raytracing: no bundle<span class="kw">&lt;/title&gt;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>    <span class="kw">&lt;style&gt;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>      <span class="pp">#scene</span> {</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>        <span class="kw">height</span>: <span class="dv">100</span><span class="dt">%</span><span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>        <span class="kw">width</span>: <span class="dv">500</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>        <span class="kw">float</span>: <span class="dv">left</span><span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>      }</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a>      <span class="pp">#render</span><span class="op">,</span> <span class="fu">.concurrency</span><span class="op">,</span> <span class="fu">.timing</span> {</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>        <span class="kw">padding</span>: <span class="dv">20</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a>        <span class="kw">margin</span>: <span class="dv">20</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a>        <span class="kw">float</span>: <span class="dv">left</span><span class="op">;</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a>      }</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true"></a>    <span class="kw">&lt;/style&gt;</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true"></a>    <span class="kw">&lt;textarea</span><span class="ot"> id=</span><span class="st">&#39;scene&#39;</span><span class="kw">&gt;</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true"></a>{</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true"></a>  &quot;width&quot;: 800,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true"></a>  &quot;height&quot;: 800,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true"></a>  &quot;fov&quot;: 90.0,</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true"></a>  &quot;shadow_bias&quot;: 1e-13,</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true"></a>  &quot;max_recursion_depth&quot;: 20,</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true"></a>  &quot;elements&quot;: [</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true"></a>    {</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true"></a>      &quot;Sphere&quot; : {</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true"></a>        &quot;center&quot;: {</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true"></a>          &quot;x&quot;: 0.0,</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true"></a>          &quot;y&quot;: 0.0,</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true"></a>          &quot;z&quot;: -5.0</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true"></a>        },</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true"></a>        &quot;radius&quot;: 1.0,</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true"></a>        &quot;material&quot;: {</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true"></a>          &quot;coloration&quot; : {</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true"></a>            &quot;Color&quot;: {</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true"></a>              &quot;red&quot;: 0.2,</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true"></a>              &quot;green&quot;: 1.0,</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true"></a>              &quot;blue&quot;: 0.2</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true"></a>            }</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true"></a>          },</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true"></a>          &quot;albedo&quot;: 0.18,</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true"></a>          &quot;surface&quot;: {</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true"></a>            &quot;Reflective&quot;: {</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true"></a>              &quot;reflectivity&quot;: 0.7</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true"></a>            }</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true"></a>          }</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true"></a>        }</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true"></a>      }</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true"></a>    },</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true"></a>    {</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true"></a>      &quot;Sphere&quot; : {</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true"></a>        &quot;center&quot;: {</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true"></a>          &quot;x&quot;: -3.0,</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true"></a>          &quot;y&quot;: 1.0,</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true"></a>          &quot;z&quot;: -6.0</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true"></a>        },</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true"></a>        &quot;radius&quot;: 2.0,</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true"></a>        &quot;material&quot;: {</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true"></a>          &quot;coloration&quot;: {</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true"></a>            &quot;Color&quot;: {</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true"></a>              &quot;red&quot;: 1.0,</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true"></a>              &quot;green&quot;: 1.0,</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true"></a>              &quot;blue&quot;: 1.0</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true"></a>            }</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true"></a>          },</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true"></a>          &quot;albedo&quot;: 0.58,</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true"></a>          &quot;surface&quot;: &quot;Diffuse&quot;</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true"></a>        }</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true"></a>      }</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true"></a>    },</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true"></a>    {</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true"></a>      &quot;Sphere&quot;: {</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true"></a>        &quot;center&quot;: {</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true"></a>          &quot;x&quot;: 2.0,</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true"></a>          &quot;y&quot;: 1.0,</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true"></a>          &quot;z&quot;: -4.0</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true"></a>        },</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true"></a>        &quot;radius&quot;: 1.5,</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true"></a>        &quot;material&quot;: {</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true"></a>          &quot;coloration&quot;: {</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true"></a>            &quot;Color&quot;: {</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true"></a>              &quot;red&quot;: 1.0,</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true"></a>              &quot;green&quot;: 1.0,</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true"></a>              &quot;blue&quot;: 1.0</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true"></a>            }</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true"></a>          },</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true"></a>          &quot;albedo&quot;: 0.18,</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true"></a>          &quot;surface&quot;: {</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true"></a>            &quot;Refractive&quot;: {</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true"></a>              &quot;index&quot;: 1.5,</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true"></a>              &quot;transparency&quot;: 1.0</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true"></a>            }</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true"></a>          }</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true"></a>        }</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true"></a>      }</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true"></a>    },</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true"></a>    {</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true"></a>      &quot;Plane&quot;: {</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true"></a>        &quot;origin&quot;: {</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true"></a>          &quot;x&quot;: 0.0,</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true"></a>          &quot;y&quot;: -2.0,</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true"></a>          &quot;z&quot;: -5.0</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true"></a>        },</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true"></a>        &quot;normal&quot;: {</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true"></a>          &quot;x&quot;: 0.0,</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true"></a>          &quot;y&quot;: -1.0,</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true"></a>          &quot;z&quot;: 0.0</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true"></a>        },</span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true"></a>        &quot;material&quot;: {</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true"></a>          &quot;coloration&quot;: {</span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true"></a>            &quot;Color&quot;: {</span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true"></a>              &quot;red&quot;: 1.0,</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true"></a>              &quot;green&quot;: 1.0,</span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true"></a>              &quot;blue&quot;: 1.0</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true"></a>            }</span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true"></a>          },</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true"></a>          &quot;albedo&quot;: 0.18,</span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true"></a>          &quot;surface&quot;: {</span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true"></a>            &quot;Reflective&quot;: {</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true"></a>              &quot;reflectivity&quot;: 0.5</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true"></a>            }</span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true"></a>          }</span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true"></a>        }</span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true"></a>      }</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true"></a>    },</span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true"></a>    {</span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true"></a>      &quot;Plane&quot;: {</span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true"></a>        &quot;origin&quot;: {</span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true"></a>          &quot;x&quot;: 0.0,</span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true"></a>          &quot;y&quot;: 0.0,</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true"></a>          &quot;z&quot;: -20.0</span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true"></a>        },</span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true"></a>        &quot;normal&quot;: {</span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true"></a>          &quot;x&quot;: 0.0,</span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true"></a>          &quot;y&quot;: 0.0,</span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true"></a>          &quot;z&quot;: -1.0</span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true"></a>        },</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true"></a>        &quot;material&quot;: {</span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true"></a>          &quot;coloration&quot;: {</span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true"></a>            &quot;Color&quot;: {</span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true"></a>              &quot;red&quot;: 0.2,</span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true"></a>              &quot;green&quot;: 0.3,</span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true"></a>              &quot;blue&quot;: 1.0</span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true"></a>            }</span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true"></a>          },</span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true"></a>          &quot;albedo&quot;: 0.38,</span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true"></a>          &quot;surface&quot;: &quot;Diffuse&quot;</span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true"></a>        }</span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true"></a>      }</span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true"></a>    }</span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true"></a>  ],</span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true"></a>  &quot;lights&quot;: [</span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true"></a>    {</span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true"></a>      &quot;Spherical&quot;: {</span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true"></a>        &quot;position&quot;: {</span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true"></a>          &quot;x&quot;: -2.0,</span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true"></a>          &quot;y&quot;: 10.0,</span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true"></a>          &quot;z&quot;: -3.0</span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true"></a>        },</span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true"></a>        &quot;color&quot;: {</span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true"></a>          &quot;red&quot;: 0.3,</span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true"></a>          &quot;green&quot;: 0.8,</span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true"></a>          &quot;blue&quot;: 0.3</span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true"></a>        },</span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true"></a>        &quot;intensity&quot;: 10000.0</span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true"></a>      }</span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true"></a>    },</span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true"></a>    {</span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true"></a>      &quot;Spherical&quot;: {</span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true"></a>        &quot;position&quot;: {</span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true"></a>          &quot;x&quot;: 0.25,</span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true"></a>          &quot;y&quot;: 0.0,</span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true"></a>          &quot;z&quot;: -2.0</span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true"></a>        },</span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true"></a>        &quot;color&quot;: {</span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true"></a>          &quot;red&quot;: 0.8,</span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true"></a>          &quot;green&quot;: 0.3,</span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true"></a>          &quot;blue&quot;: 0.3</span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true"></a>        },</span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true"></a>        &quot;intensity&quot;: 250.0</span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true"></a>      }</span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true"></a>    },</span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true"></a>    {</span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true"></a>      &quot;Directional&quot;: {</span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true"></a>        &quot;direction&quot;: {</span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true"></a>          &quot;x&quot;: 0.0,</span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true"></a>          &quot;y&quot;: 0.0,</span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true"></a>          &quot;z&quot;: -1.0</span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true"></a>        },</span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true"></a>        &quot;color&quot;: {</span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true"></a>          &quot;red&quot;: 1.0,</span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true"></a>          &quot;green&quot;: 1.0,</span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true"></a>          &quot;blue&quot;: 1.0</span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true"></a>        },</span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true"></a>        &quot;intensity&quot;: 0.0</span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true"></a>      }</span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true"></a>    }</span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true"></a>  ]</span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true"></a>}</span>
<span id="cb3-204"><a href="#cb3-204" aria-hidden="true"></a>    <span class="kw">&lt;/textarea&gt;</span></span>
<span id="cb3-205"><a href="#cb3-205" aria-hidden="true"></a></span>
<span id="cb3-206"><a href="#cb3-206" aria-hidden="true"></a>    <span class="kw">&lt;button</span><span class="ot"> disabled id=</span><span class="st">&#39;render&#39;</span><span class="kw">&gt;</span>Loading wasm...<span class="kw">&lt;/button&gt;</span></span>
<span id="cb3-207"><a href="#cb3-207" aria-hidden="true"></a>    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&#39;concurrency&#39;</span><span class="kw">&gt;</span></span>
<span id="cb3-208"><a href="#cb3-208" aria-hidden="true"></a>      <span class="kw">&lt;p</span><span class="ot"> id=</span><span class="st">&#39;concurrency-amt&#39;</span><span class="kw">&gt;</span>Concurrency: 1<span class="kw">&lt;/p&gt;</span></span>
<span id="cb3-209"><a href="#cb3-209" aria-hidden="true"></a>      <span class="kw">&lt;br/&gt;</span></span>
<span id="cb3-210"><a href="#cb3-210" aria-hidden="true"></a>      <span class="kw">&lt;input</span><span class="ot"> disabled type=</span><span class="st">&quot;range&quot;</span><span class="ot"> id=</span><span class="st">&quot;concurrency&quot;</span><span class="ot"> min=</span><span class="st">&quot;0&quot;</span><span class="ot"> max=</span><span class="st">&quot;1&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb3-211"><a href="#cb3-211" aria-hidden="true"></a>    <span class="kw">&lt;/div&gt;</span></span>
<span id="cb3-212"><a href="#cb3-212" aria-hidden="true"></a>    <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&#39;timing&#39;</span><span class="kw">&gt;</span></span>
<span id="cb3-213"><a href="#cb3-213" aria-hidden="true"></a>      Render duration:</span>
<span id="cb3-214"><a href="#cb3-214" aria-hidden="true"></a>      <span class="kw">&lt;p</span><span class="ot"> id=</span><span class="st">&#39;timing-val&#39;</span><span class="kw">&gt;&lt;/p&gt;</span></span>
<span id="cb3-215"><a href="#cb3-215" aria-hidden="true"></a>    <span class="kw">&lt;/div&gt;</span></span>
<span id="cb3-216"><a href="#cb3-216" aria-hidden="true"></a></span>
<span id="cb3-217"><a href="#cb3-217" aria-hidden="true"></a></span>
<span id="cb3-218"><a href="#cb3-218" aria-hidden="true"></a>    <span class="kw">&lt;canvas</span><span class="ot"> id=</span><span class="st">&#39;canvas&#39;</span><span class="kw">&gt;&lt;/canvas&gt;</span></span>
<span id="cb3-219"><a href="#cb3-219" aria-hidden="true"></a></span>
<span id="cb3-220"><a href="#cb3-220" aria-hidden="true"></a>    <span class="kw">&lt;script&gt;</span></span>
<span id="cb3-221"><a href="#cb3-221" aria-hidden="true"></a>      <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;render&#39;</span>)<span class="op">.</span><span class="at">disabled</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb3-222"><a href="#cb3-222" aria-hidden="true"></a>      <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;concurrency&#39;</span>)<span class="op">.</span><span class="at">disabled</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb3-223"><a href="#cb3-223" aria-hidden="true"></a>    <span class="kw">&lt;/script&gt;</span></span>
<span id="cb3-224"><a href="#cb3-224" aria-hidden="true"></a>    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&#39;../pkg/raytrace_parallel.js&#39;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb3-225"><a href="#cb3-225" aria-hidden="true"></a>    <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="ot"> src=</span><span class="st">&quot;../js/index.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb3-226"><a href="#cb3-226" aria-hidden="true"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb3-227"><a href="#cb3-227" aria-hidden="true"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<ul>
<li>index.js</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="kw">const</span> button <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;render&#39;</span>)<span class="op">;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="kw">const</span> canvas <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;canvas&#39;</span>)<span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="kw">const</span> scene <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;scene&#39;</span>)<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="kw">const</span> concurrency <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;concurrency&#39;</span>)<span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a><span class="kw">const</span> concurrencyAmt <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;concurrency-amt&#39;</span>)<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a><span class="kw">const</span> timing <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;timing&#39;</span>)<span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a><span class="kw">const</span> timingVal <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;timing-val&#39;</span>)<span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a><span class="kw">const</span> ctx <span class="op">=</span> canvas<span class="op">.</span><span class="fu">getContext</span>(<span class="st">&#39;2d&#39;</span>)<span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>button<span class="op">.</span><span class="at">disabled</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>concurrency<span class="op">.</span><span class="at">disabled</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a><span class="co">// First up, but try to do feature detection to provide better error messages</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a><span class="kw">function</span> <span class="fu">loadWasm</span>() {</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a>  <span class="kw">let</span> msg <span class="op">=</span> <span class="st">&#39;This demo requires a current version of Firefox (e.g., 79.0)&#39;</span><span class="op">;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a>  <span class="cf">if</span> (<span class="kw">typeof</span> <span class="bu">SharedArrayBuffer</span> <span class="op">!==</span> <span class="st">&#39;function&#39;</span>) {</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a>    <span class="fu">alert</span>(<span class="st">&#39;this browser does not have SharedArrayBuffer support enabled&#39;</span> <span class="op">+</span> <span class="st">&#39;</span><span class="sc">\n\n</span><span class="st">&#39;</span> <span class="op">+</span> msg)<span class="op">;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true"></a>    <span class="cf">return</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true"></a>  }</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true"></a>  <span class="co">// Test for bulk memory operations with passive data segments</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true"></a>  <span class="co">//  (module (memory 1) (data passive &quot;&quot;))</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true"></a>  <span class="kw">const</span> buf <span class="op">=</span> <span class="kw">new</span> <span class="bu">Uint8Array</span>([<span class="bn">0x00</span><span class="op">,</span> <span class="bn">0x61</span><span class="op">,</span> <span class="bn">0x73</span><span class="op">,</span> <span class="bn">0x6d</span><span class="op">,</span> <span class="bn">0x01</span><span class="op">,</span> <span class="bn">0x00</span><span class="op">,</span> <span class="bn">0x00</span><span class="op">,</span> <span class="bn">0x00</span><span class="op">,</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true"></a>    <span class="bn">0x05</span><span class="op">,</span> <span class="bn">0x03</span><span class="op">,</span> <span class="bn">0x01</span><span class="op">,</span> <span class="bn">0x00</span><span class="op">,</span> <span class="bn">0x01</span><span class="op">,</span> <span class="bn">0x0b</span><span class="op">,</span> <span class="bn">0x03</span><span class="op">,</span> <span class="bn">0x01</span><span class="op">,</span> <span class="bn">0x01</span><span class="op">,</span> <span class="bn">0x00</span>])<span class="op">;</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true"></a>  <span class="cf">if</span> (<span class="op">!</span>WebAssembly<span class="op">.</span><span class="fu">validate</span>(buf)) {</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true"></a>    <span class="fu">alert</span>(<span class="st">&#39;this browser does not support passive wasm memory, demo does not work&#39;</span> <span class="op">+</span> <span class="st">&#39;</span><span class="sc">\n\n</span><span class="st">&#39;</span> <span class="op">+</span> msg)<span class="op">;</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true"></a>    <span class="cf">return</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true"></a>  }</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true"></a>  <span class="fu">wasm_bindgen</span>()</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true"></a>    <span class="op">.</span><span class="fu">then</span>(run)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true"></a>    <span class="op">.</span><span class="fu">catch</span>(<span class="bu">console</span><span class="op">.</span><span class="fu">error</span>)<span class="op">;</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true"></a>}</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true"></a></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true"></a><span class="fu">loadWasm</span>()<span class="op">;</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true"></a><span class="kw">const</span> { Scene<span class="op">,</span> WorkerPool } <span class="op">=</span> wasm_bindgen<span class="op">;</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true"></a><span class="kw">function</span> <span class="fu">run</span>() {</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true"></a>  <span class="co">// The maximal concurrency of our web worker pool is `hardwareConcurrency`,</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true"></a>  <span class="co">// so set that up here and this ideally is the only location we create web</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true"></a>  <span class="co">// workers.</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true"></a>  pool <span class="op">=</span> <span class="kw">new</span> <span class="fu">WorkerPool</span>(<span class="bu">navigator</span><span class="op">.</span><span class="at">hardwareConcurrency</span>)<span class="op">;</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true"></a></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true"></a>  <span class="co">// Configure various buttons and such.</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true"></a>  button<span class="op">.</span><span class="at">onclick</span> <span class="op">=</span> <span class="kw">function</span>() {</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true"></a>    button<span class="op">.</span><span class="at">disabled</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">time</span>(<span class="st">&#39;render&#39;</span>)<span class="op">;</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true"></a>    <span class="kw">let</span> json<span class="op">;</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true"></a>    <span class="cf">try</span> {</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true"></a>      json <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(scene<span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true"></a>    } <span class="cf">catch</span>(e) {</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true"></a>      <span class="fu">alert</span>(<span class="vs">`invalid json: </span><span class="sc">${</span>e<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true"></a>      <span class="cf">return</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true"></a>    }</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true"></a>    canvas<span class="op">.</span><span class="at">width</span> <span class="op">=</span> json<span class="op">.</span><span class="at">width</span><span class="op">;</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true"></a>    canvas<span class="op">.</span><span class="at">height</span> <span class="op">=</span> json<span class="op">.</span><span class="at">height</span><span class="op">;</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true"></a>    <span class="fu">render</span>(<span class="kw">new</span> <span class="fu">Scene</span>(json))<span class="op">;</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true"></a>  }<span class="op">;</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true"></a>  button<span class="op">.</span><span class="at">innerText</span> <span class="op">=</span> <span class="st">&#39;Render!&#39;</span><span class="op">;</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true"></a>  button<span class="op">.</span><span class="at">disabled</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true"></a></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true"></a>  concurrency<span class="op">.</span><span class="at">oninput</span> <span class="op">=</span> <span class="kw">function</span>() {</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true"></a>    concurrencyAmt<span class="op">.</span><span class="at">innerText</span> <span class="op">=</span> <span class="st">&#39;Concurrency: &#39;</span> <span class="op">+</span> concurrency<span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true"></a>  }<span class="op">;</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true"></a>  concurrency<span class="op">.</span><span class="at">min</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true"></a>  concurrency<span class="op">.</span><span class="at">step</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true"></a>  concurrency<span class="op">.</span><span class="at">max</span> <span class="op">=</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">hardwareConcurrency</span><span class="op">;</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true"></a>  concurrency<span class="op">.</span><span class="at">value</span> <span class="op">=</span> concurrency<span class="op">.</span><span class="at">max</span><span class="op">;</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true"></a>  concurrency<span class="op">.</span><span class="fu">oninput</span>()<span class="op">;</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true"></a>  concurrency<span class="op">.</span><span class="at">disabled</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true"></a>}</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true"></a></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true"></a><span class="kw">let</span> rendering <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true"></a><span class="kw">let</span> start <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true"></a><span class="kw">let</span> interval <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true"></a><span class="kw">let</span> pool <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true"></a></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true"></a><span class="kw">class</span> State {</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true"></a>  <span class="fu">constructor</span>(wasm) {</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">start</span> <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">wasm</span> <span class="op">=</span> wasm<span class="op">;</span></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">running</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">counter</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true"></a></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">interval</span> <span class="op">=</span> <span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">updateTimer</span>(<span class="kw">true</span>)<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true"></a></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true"></a>    wasm<span class="op">.</span><span class="fu">promise</span>()</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true"></a>      <span class="op">.</span><span class="fu">then</span>(data <span class="kw">=&gt;</span> {</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">updateTimer</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">updateImage</span>(data)<span class="op">;</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">stop</span>()<span class="op">;</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true"></a>      })</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true"></a>      <span class="op">.</span><span class="fu">catch</span>(<span class="bu">console</span><span class="op">.</span><span class="fu">error</span>)<span class="op">;</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true"></a>  }</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true"></a></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true"></a>  <span class="fu">updateTimer</span>(updateImage) {</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true"></a>    <span class="kw">const</span> dur <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> <span class="kw">this</span><span class="op">.</span><span class="at">start</span><span class="op">;</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true"></a>    timingVal<span class="op">.</span><span class="at">innerText</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>dur<span class="sc">}</span><span class="vs">ms`</span><span class="op">;</span></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">counter</span> <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true"></a></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true"></a>    <span class="cf">if</span> (updateImage <span class="op">&amp;&amp;</span> <span class="kw">this</span><span class="op">.</span><span class="at">wasm</span> <span class="op">&amp;&amp;</span> <span class="kw">this</span><span class="op">.</span><span class="at">counter</span> <span class="op">%</span> <span class="dv">3</span> <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">updateImage</span>(<span class="kw">this</span><span class="op">.</span><span class="at">wasm</span><span class="op">.</span><span class="fu">imageSoFar</span>())<span class="op">;</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true"></a>  }</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true"></a></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true"></a>  <span class="fu">updateImage</span>(data) {</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true"></a>    ctx<span class="op">.</span><span class="fu">putImageData</span>(data<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true"></a>  }</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true"></a></span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true"></a>  <span class="fu">stop</span>() {</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">running</span>)</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">timeEnd</span>(<span class="st">&#39;render&#39;</span>)<span class="op">;</span></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">running</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">wasm</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true"></a>    <span class="pp">clearInterval</span>(<span class="kw">this</span><span class="op">.</span><span class="at">interval</span>)<span class="op">;</span></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true"></a>    button<span class="op">.</span><span class="at">disabled</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true"></a>  }</span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true"></a>}</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true"></a></span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true"></a><span class="kw">function</span> <span class="fu">render</span>(scene) {</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true"></a>  <span class="cf">if</span> (rendering) {</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true"></a>    rendering<span class="op">.</span><span class="fu">stop</span>()<span class="op">;</span></span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true"></a>    rendering <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true"></a>  }</span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true"></a>  rendering <span class="op">=</span> <span class="kw">new</span> <span class="fu">State</span>(scene<span class="op">.</span><span class="fu">render</span>(<span class="pp">parseInt</span>(concurrency<span class="op">.</span><span class="at">value</span>)<span class="op">,</span> pool))<span class="op">;</span></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true"></a>}</span></code></pre></div>
<ul>
<li>worker.js</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="co">// synchronously, using the browser, import out shim JS scripts</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a><span class="fu">importScripts</span>(<span class="st">&#39;pkg/raytrace_parallel.js&#39;</span>)<span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a><span class="co">// Wait for the main thread to send us the shared module/memory. Once we&#39;ve got</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a><span class="co">// it, initialize it all with the `wasm_bindgen` global we imported via</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a><span class="co">// `importScripts`.</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a><span class="co">//</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a><span class="co">// After our first message all subsequent messages are an entry point to run,</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a><span class="co">// so we just do that.</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a>self<span class="op">.</span><span class="at">onmessage</span> <span class="op">=</span> <span class="bu">event</span> <span class="kw">=&gt;</span> {</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a>  <span class="kw">let</span> initialised <span class="op">=</span> <span class="fu">wasm_bindgen</span>(<span class="op">...</span><span class="bu">event</span><span class="op">.</span><span class="at">data</span>)<span class="op">.</span><span class="fu">catch</span>(err <span class="kw">=&gt;</span> {</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true"></a>    <span class="co">// Propagate to main `onerror`:</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true"></a>    <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true"></a>      <span class="cf">throw</span> err<span class="op">;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true"></a>    })<span class="op">;</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true"></a>    <span class="co">// Rethrow to keep promise rejected and prevent execution of further commands:</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true"></a>    <span class="cf">throw</span> err<span class="op">;</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true"></a>  })<span class="op">;</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true"></a>  self<span class="op">.</span><span class="at">onmessage</span> <span class="op">=</span> <span class="kw">async</span> <span class="bu">event</span> <span class="kw">=&gt;</span> {</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true"></a>    <span class="co">// This will queue further commands up until the module is fully initialised:</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true"></a>    <span class="cf">await</span> initialised<span class="op">;</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true"></a>    wasm_bindgen<span class="op">.</span><span class="fu">child_entry_point</span>(<span class="bu">event</span><span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true"></a>  }<span class="op">;</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true"></a>}<span class="op">;</span></span></code></pre></div>
<ul>
<li>Rust side</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="co">// src/lib.rs</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="kw">use</span> <span class="pp">futures_channel::</span>oneshot<span class="op">;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="kw">use</span> <span class="pp">js_sys::</span><span class="op">{</span>Promise<span class="op">,</span> Uint8ClampedArray<span class="op">,</span> WebAssembly<span class="op">};</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="kw">use</span> <span class="pp">rayon::prelude::</span><span class="op">*;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="kw">use</span> <span class="pp">wasm_bindgen::prelude::</span><span class="op">*;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a><span class="pp">macro_rules!</span> console_log <span class="op">{</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>    (<span class="op">$</span>(<span class="op">$</span>t<span class="op">:</span>tt)<span class="op">*</span>) <span class="op">=&gt;</span> (<span class="kw">crate</span><span class="pp">::</span>log(<span class="op">&amp;</span><span class="pp">format_args!</span>(<span class="op">$</span>(<span class="op">$</span>t)<span class="op">*</span>)<span class="op">.</span>to_string()))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a><span class="op">}</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a><span class="kw">mod</span> pool<span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a><span class="at">#[</span>wasm_bindgen<span class="at">]</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true"></a><span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="op">{</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true"></a>    <span class="at">#[</span>wasm_bindgen<span class="at">(</span>js_namespace <span class="op">=</span> console<span class="at">)]</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true"></a>    <span class="kw">fn</span> log(s<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>)<span class="op">;</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true"></a>    <span class="at">#[</span>wasm_bindgen<span class="at">(</span>js_namespace <span class="op">=</span> console<span class="op">,</span> js_name <span class="op">=</span> log<span class="at">)]</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true"></a>    <span class="kw">fn</span> logv(x<span class="op">:</span> <span class="op">&amp;</span>JsValue)<span class="op">;</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true"></a><span class="op">}</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true"></a><span class="at">#[</span>wasm_bindgen<span class="at">]</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true"></a><span class="kw">pub</span> <span class="kw">struct</span> Scene <span class="op">{</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true"></a>    inner<span class="op">:</span> <span class="pp">raytracer::scene::</span>Scene<span class="op">,</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true"></a><span class="op">}</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true"></a><span class="at">#[</span>wasm_bindgen<span class="at">]</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true"></a><span class="kw">impl</span> Scene <span class="op">{</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true"></a>    <span class="co">/// Creates a new scene from the JSON description in `object`, which we</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true"></a>    <span class="co">/// deserialize here into an actual scene.</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true"></a>    <span class="at">#[</span>wasm_bindgen<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new(object<span class="op">:</span> JsValue) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Scene<span class="op">,</span> JsValue<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true"></a>        <span class="pp">console_error_panic_hook::</span>set_once()<span class="op">;</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true"></a>        <span class="cn">Ok</span>(Scene <span class="op">{</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true"></a>            inner<span class="op">:</span> <span class="pp">serde_wasm_bindgen::</span>from_value(object)</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true"></a>                <span class="op">.</span>map_err(<span class="op">|</span>e<span class="op">|</span> <span class="pp">JsValue::</span>from(e<span class="op">.</span>to_string()))<span class="op">?,</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true"></a>        <span class="op">}</span>)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true"></a>    <span class="op">}</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true"></a></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true"></a>    <span class="co">/// Renders this scene with the provided concurrency and worker pool.</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true"></a>    <span class="co">/// This will spawn up to `concurrency` workers which are loaded from or</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true"></a>    <span class="co">/// spawned into `pool`. The `RenderingScene` state contains information to</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true"></a>    <span class="co">/// get notifications when the render has completed.</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true"></a>    <span class="kw">pub</span> <span class="kw">fn</span> render(</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true"></a>        <span class="kw">self</span><span class="op">,</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true"></a>        concurrency<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true"></a>        pool<span class="op">:</span> <span class="op">&amp;</span><span class="pp">pool::</span>WorkerPool<span class="op">,</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true"></a>    ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>RenderingScene<span class="op">,</span> JsValue<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true"></a>        <span class="kw">let</span> scene <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>inner<span class="op">;</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true"></a>        <span class="kw">let</span> height <span class="op">=</span> scene<span class="op">.</span>height<span class="op">;</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true"></a>        <span class="kw">let</span> width <span class="op">=</span> scene<span class="op">.</span>width<span class="op">;</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true"></a></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true"></a>        <span class="co">// Allocate the pixel data which our threads will be writing into.</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true"></a>        <span class="kw">let</span> pixels <span class="op">=</span> (width <span class="op">*</span> height) <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true"></a>        <span class="kw">let</span> <span class="kw">mut</span> rgb_data <span class="op">=</span> <span class="pp">vec!</span>[<span class="dv">0</span><span class="op">;</span> <span class="dv">4</span> <span class="op">*</span> pixels]<span class="op">;</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true"></a>        <span class="kw">let</span> base <span class="op">=</span> rgb_data<span class="op">.</span>as_ptr() <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true"></a>        <span class="kw">let</span> len <span class="op">=</span> rgb_data<span class="op">.</span>len()<span class="op">;</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true"></a></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true"></a>        <span class="co">// Configure a rayon thread pool which will pull web workers from</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true"></a>        <span class="co">// `pool`.</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true"></a>        <span class="kw">let</span> thread_pool <span class="op">=</span> <span class="pp">rayon::ThreadPoolBuilder::</span>new()</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true"></a>            <span class="op">.</span>num_threads(concurrency)</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true"></a>            <span class="op">.</span>spawn_handler(<span class="op">|</span>thread<span class="op">|</span> <span class="op">{</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true"></a>                pool<span class="op">.</span>run(<span class="op">||</span> thread<span class="op">.</span>run())<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true"></a>                <span class="cn">Ok</span>(())</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true"></a>            <span class="op">}</span>)</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true"></a>            <span class="op">.</span>build()</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true"></a>            <span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true"></a></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true"></a>        <span class="co">// And now execute the render! The entire render happens on our worker</span></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true"></a>        <span class="co">// threads so we don&#39;t lock up the main thread, so we ship off a thread</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true"></a>        <span class="co">// which actually does the whole rayon business. When our returned</span></span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true"></a>        <span class="co">// future is resolved we can pull out the final version of the image.</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true"></a>        <span class="kw">let</span> (tx<span class="op">,</span> rx) <span class="op">=</span> <span class="pp">oneshot::</span>channel()<span class="op">;</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true"></a>        pool<span class="op">.</span>run(<span class="kw">move</span> <span class="op">||</span> <span class="op">{</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true"></a>            thread_pool<span class="op">.</span>install(<span class="op">||</span> <span class="op">{</span></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true"></a>                rgb_data</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true"></a>                    <span class="op">.</span>par_chunks_mut(<span class="dv">4</span>)</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true"></a>                    <span class="op">.</span>enumerate()</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true"></a>                    <span class="op">.</span>for_each(<span class="op">|</span>(i<span class="op">,</span> chunk)<span class="op">|</span> <span class="op">{</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true"></a>                        <span class="kw">let</span> i <span class="op">=</span> i <span class="kw">as</span> <span class="dt">u32</span><span class="op">;</span></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true"></a>                        <span class="kw">let</span> x <span class="op">=</span> i <span class="op">%</span> width<span class="op">;</span></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true"></a>                        <span class="kw">let</span> y <span class="op">=</span> i <span class="op">/</span> width<span class="op">;</span></span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true"></a>                        <span class="kw">let</span> ray <span class="op">=</span> <span class="pp">raytracer::Ray::</span>create_prime(x<span class="op">,</span> y<span class="op">,</span> <span class="op">&amp;</span>scene)<span class="op">;</span></span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true"></a>                        <span class="kw">let</span> result <span class="op">=</span> <span class="pp">raytracer::</span>cast_ray(<span class="op">&amp;</span>scene<span class="op">,</span> <span class="op">&amp;</span>ray<span class="op">,</span> <span class="dv">0</span>)<span class="op">.</span>to_rgba()<span class="op">;</span></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true"></a>                        chunk[<span class="dv">0</span>] <span class="op">=</span> result<span class="op">.</span>data[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true"></a>                        chunk[<span class="dv">1</span>] <span class="op">=</span> result<span class="op">.</span>data[<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true"></a>                        chunk[<span class="dv">2</span>] <span class="op">=</span> result<span class="op">.</span>data[<span class="dv">2</span>]<span class="op">;</span></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true"></a>                        chunk[<span class="dv">3</span>] <span class="op">=</span> result<span class="op">.</span>data[<span class="dv">3</span>]<span class="op">;</span></span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true"></a>                    <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true"></a>            drop(tx<span class="op">.</span>send(rgb_data))<span class="op">;</span></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true"></a>        <span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true"></a></span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true"></a>        <span class="kw">let</span> done <span class="op">=</span> <span class="kw">async</span> <span class="kw">move</span> <span class="op">{</span></span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true"></a>            <span class="kw">match</span> rx<span class="op">.</span><span class="kw">await</span> <span class="op">{</span></span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true"></a>                <span class="cn">Ok</span>(_data) <span class="op">=&gt;</span> <span class="cn">Ok</span>(image_data(base<span class="op">,</span> len<span class="op">,</span> width<span class="op">,</span> height)<span class="op">.</span>into())<span class="op">,</span></span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true"></a>                <span class="cn">Err</span>(_) <span class="op">=&gt;</span> <span class="cn">Err</span>(<span class="pp">JsValue::</span>undefined())<span class="op">,</span></span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true"></a>            <span class="op">}</span></span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true"></a>        <span class="op">};</span></span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true"></a></span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true"></a>        <span class="cn">Ok</span>(RenderingScene <span class="op">{</span></span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true"></a>            promise<span class="op">:</span> <span class="pp">wasm_bindgen_futures::</span>future_to_promise(done)<span class="op">,</span></span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true"></a>            base<span class="op">,</span></span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true"></a>            len<span class="op">,</span></span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true"></a>            height<span class="op">,</span></span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true"></a>            width<span class="op">,</span></span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true"></a>        <span class="op">}</span>)</span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true"></a>    <span class="op">}</span></span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true"></a><span class="op">}</span></span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true"></a></span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true"></a><span class="at">#[</span>wasm_bindgen<span class="at">]</span></span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true"></a><span class="kw">pub</span> <span class="kw">struct</span> RenderingScene <span class="op">{</span></span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true"></a>    base<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true"></a>    len<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true"></a>    promise<span class="op">:</span> Promise<span class="op">,</span></span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true"></a>    width<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true"></a>    height<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true"></a><span class="op">}</span></span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true"></a></span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true"></a><span class="co">// Inline the definition of `ImageData` here because `web_sys` uses</span></span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true"></a><span class="co">// `&amp;Clamped&lt;Vec&lt;u8&gt;&gt;`, whereas we want to pass in a JS object here.</span></span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true"></a><span class="at">#[</span>wasm_bindgen<span class="at">]</span></span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true"></a><span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="op">{</span></span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true"></a>    <span class="kw">pub</span> <span class="kw">type</span> ImageData<span class="op">;</span></span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true"></a></span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true"></a>    <span class="at">#[</span>wasm_bindgen<span class="at">(</span>constructor<span class="op">,</span> catch<span class="at">)]</span></span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true"></a>    <span class="kw">fn</span> new(data<span class="op">:</span> <span class="op">&amp;</span>Uint8ClampedArray<span class="op">,</span> width<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span> height<span class="op">:</span> <span class="dt">f64</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>ImageData<span class="op">,</span> JsValue<span class="op">&gt;;</span></span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true"></a><span class="op">}</span></span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true"></a></span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true"></a><span class="at">#[</span>wasm_bindgen<span class="at">]</span></span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true"></a><span class="kw">impl</span> RenderingScene <span class="op">{</span></span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true"></a>    <span class="co">/// Returns the JS promise object which resolves when the render is complete</span></span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true"></a>    <span class="kw">pub</span> <span class="kw">fn</span> promise(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> Promise <span class="op">{</span></span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true"></a>        <span class="kw">self</span><span class="op">.</span>promise<span class="op">.</span>clone()</span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true"></a>    <span class="op">}</span></span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true"></a></span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true"></a>    <span class="co">/// Return a progressive rendering of the image so far</span></span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true"></a>    <span class="at">#[</span>wasm_bindgen<span class="at">(</span>js_name <span class="op">=</span> imageSoFar<span class="at">)]</span></span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true"></a>    <span class="kw">pub</span> <span class="kw">fn</span> image_so_far(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> ImageData <span class="op">{</span></span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true"></a>        image_data(<span class="kw">self</span><span class="op">.</span>base<span class="op">,</span> <span class="kw">self</span><span class="op">.</span>len<span class="op">,</span> <span class="kw">self</span><span class="op">.</span>width<span class="op">,</span> <span class="kw">self</span><span class="op">.</span>height)</span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true"></a>    <span class="op">}</span></span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true"></a><span class="op">}</span></span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true"></a></span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true"></a><span class="kw">fn</span> image_data(base<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span> len<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span> width<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span> height<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> ImageData <span class="op">{</span></span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true"></a>    <span class="co">// Use the raw access available through `memory.buffer`, but be sure to</span></span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true"></a>    <span class="co">// use `slice` instead of `subarray` to create a copy that isn&#39;t backed</span></span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true"></a>    <span class="co">// by `SharedArrayBuffer`. Currently `ImageData` rejects a view of</span></span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true"></a>    <span class="co">// `Uint8ClampedArray` that&#39;s backed by a shared buffer.</span></span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true"></a>    <span class="co">//</span></span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true"></a>    <span class="co">// </span><span class="al">FIXME</span><span class="co">: that this may or may not be UB based on Rust&#39;s rules. For example</span></span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true"></a>    <span class="co">// threads may be doing unsynchronized writes to pixel data as we read it</span></span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true"></a>    <span class="co">// off here. In the context of wasm this may or may not be UB, we&#39;re</span></span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true"></a>    <span class="co">// unclear! In any case for now it seems to work and produces a nifty</span></span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true"></a>    <span class="co">// progressive rendering. A more production-ready application may prefer to</span></span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true"></a>    <span class="co">// instead use some form of signaling here to request an update from the</span></span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true"></a>    <span class="co">// workers instead of synchronously acquiring an update, and that way we</span></span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true"></a>    <span class="co">// could ensure that even on the Rust side of things it&#39;s not UB.</span></span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true"></a>    <span class="kw">let</span> mem <span class="op">=</span> <span class="pp">wasm_bindgen::</span>memory()<span class="op">.</span><span class="pp">unchecked_into::</span><span class="op">&lt;</span><span class="pp">WebAssembly::</span>Memory<span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true"></a>    <span class="kw">let</span> mem <span class="op">=</span> <span class="pp">Uint8ClampedArray::</span>new(<span class="op">&amp;</span>mem<span class="op">.</span>buffer())<span class="op">.</span>slice(base <span class="kw">as</span> <span class="dt">u32</span><span class="op">,</span> (base <span class="op">+</span> len) <span class="kw">as</span> <span class="dt">u32</span>)<span class="op">;</span></span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true"></a>    <span class="pp">ImageData::</span>new(<span class="op">&amp;</span>mem<span class="op">,</span> width <span class="kw">as</span> <span class="dt">f64</span><span class="op">,</span> height <span class="kw">as</span> <span class="dt">f64</span>)<span class="op">.</span>unwrap()</span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true"></a><span class="op">}</span></span></code></pre></div>
<ul>
<li>pool.rs</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="co">// src/pool.rs</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="co">// Silences warnings from the compiler about Work.func and child_entry_point</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a><span class="co">// being unused when the target is not wasm.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a><span class="at">#![</span>cfg_attr<span class="at">(</span>not<span class="at">(</span>target_arch <span class="op">=</span> <span class="st">&quot;wasm32&quot;</span><span class="at">)</span><span class="op">,</span> allow<span class="at">(</span>dead_code<span class="at">))]</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a><span class="co">//! A small module that&#39;s intended to provide an example of creating a pool of</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a><span class="co">//! web workers which can be used to execute `rayon`-style work.</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a><span class="kw">use</span> <span class="pp">std::cell::</span>RefCell<span class="op">;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a><span class="kw">use</span> <span class="pp">std::rc::</span>Rc<span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true"></a><span class="kw">use</span> <span class="pp">wasm_bindgen::prelude::</span><span class="op">*;</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true"></a><span class="kw">use</span> <span class="pp">web_sys::</span><span class="op">{</span>DedicatedWorkerGlobalScope<span class="op">,</span> MessageEvent<span class="op">};</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true"></a><span class="kw">use</span> <span class="pp">web_sys::</span><span class="op">{</span>ErrorEvent<span class="op">,</span> Event<span class="op">,</span> Worker<span class="op">};</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true"></a><span class="at">#[</span>wasm_bindgen<span class="at">]</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true"></a><span class="kw">pub</span> <span class="kw">struct</span> WorkerPool <span class="op">{</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true"></a>    state<span class="op">:</span> Rc<span class="op">&lt;</span>PoolState<span class="op">&gt;,</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true"></a><span class="op">}</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true"></a><span class="kw">struct</span> PoolState <span class="op">{</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true"></a>    workers<span class="op">:</span> RefCell<span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>Worker<span class="op">&gt;&gt;,</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true"></a>    callback<span class="op">:</span> Closure<span class="op">&lt;</span><span class="kw">dyn</span> <span class="bu">FnMut</span>(Event)<span class="op">&gt;,</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true"></a><span class="op">}</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true"></a><span class="kw">struct</span> Work <span class="op">{</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true"></a>    func<span class="op">:</span> <span class="dt">Box</span><span class="op">&lt;</span><span class="kw">dyn</span> <span class="bu">FnOnce</span>() <span class="op">+</span> <span class="bu">Send</span><span class="op">&gt;,</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true"></a><span class="op">}</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true"></a><span class="at">#[</span>wasm_bindgen<span class="at">]</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true"></a><span class="kw">impl</span> WorkerPool <span class="op">{</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true"></a>    <span class="co">/// Creates a new `WorkerPool` which immediately creates `initial` workers.</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true"></a>    <span class="co">/// The pool created here can be used over a long period of time, and it</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true"></a>    <span class="co">/// will be initially primed with `initial` workers. Currently workers are</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true"></a>    <span class="co">/// never released or gc&#39;d until the whole pool is destroyed.</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true"></a>    <span class="co">/// # Errors</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true"></a>    <span class="co">/// Returns any error that may happen while a JS web worker is created and a</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true"></a>    <span class="co">/// message is sent to it.</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true"></a>    <span class="at">#[</span>wasm_bindgen<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new(initial<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>WorkerPool<span class="op">,</span> JsValue<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true"></a>        <span class="kw">let</span> pool <span class="op">=</span> WorkerPool <span class="op">{</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true"></a>            state<span class="op">:</span> <span class="pp">Rc::</span>new(PoolState <span class="op">{</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true"></a>                workers<span class="op">:</span> <span class="pp">RefCell::</span>new(<span class="dt">Vec</span><span class="pp">::</span>with_capacity(initial))<span class="op">,</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true"></a>                callback<span class="op">:</span> <span class="pp">Closure::</span>new(<span class="op">|</span>event<span class="op">:</span> Event<span class="op">|</span> <span class="op">{</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true"></a>                    <span class="pp">console_log!</span>(<span class="st">&quot;unhandled event: {}&quot;</span><span class="op">,</span> event<span class="op">.</span>type_())<span class="op">;</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true"></a>                    <span class="kw">crate</span><span class="pp">::</span>logv(<span class="op">&amp;</span>event)<span class="op">;</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true"></a>                <span class="op">}</span>)<span class="op">,</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true"></a>            <span class="op">}</span>)<span class="op">,</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true"></a>        <span class="op">};</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true"></a>        <span class="kw">for</span> _ <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span>initial <span class="op">{</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true"></a>            <span class="kw">let</span> worker <span class="op">=</span> pool<span class="op">.</span>spawn()<span class="op">?;</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true"></a>            pool<span class="op">.</span>state<span class="op">.</span>push(worker)<span class="op">;</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true"></a>        <span class="op">}</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true"></a></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true"></a>        <span class="cn">Ok</span>(pool)</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true"></a>    <span class="op">}</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true"></a></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true"></a>    <span class="co">/// Unconditionally spawns a new worker</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true"></a>    <span class="co">/// The worker isn&#39;t registered with this `WorkerPool` but is capable of</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true"></a>    <span class="co">/// executing work for this wasm module.</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true"></a>    <span class="co">/// # Errors</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true"></a>    <span class="co">/// Returns any error that may happen while a JS web worker is created and a</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true"></a>    <span class="co">/// message is sent to it.</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true"></a>    <span class="kw">fn</span> spawn(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Worker<span class="op">,</span> JsValue<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true"></a>        <span class="pp">console_log!</span>(<span class="st">&quot;spawning new worker&quot;</span>)<span class="op">;</span></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true"></a>        <span class="co">// </span><span class="al">TODO</span><span class="co">: what do do about `./worker.js`:</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true"></a>        <span class="co">//</span></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true"></a>        <span class="co">// * the path is only known by the bundler. How can we, as a</span></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true"></a>        <span class="co">//   library, know what&#39;s going on?</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true"></a>        <span class="co">// * How do we not fetch a script N times? It internally then</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true"></a>        <span class="co">//   causes another script to get fetched N times...</span></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true"></a>        <span class="kw">let</span> worker <span class="op">=</span> <span class="pp">Worker::</span>new(<span class="st">&quot;./worker.js&quot;</span>)<span class="op">?;</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true"></a></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true"></a>        <span class="co">// With a worker spun up send it the module/memory so it can start</span></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true"></a>        <span class="co">// instantiating the wasm module. Later it might receive further</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true"></a>        <span class="co">// messages about code to run on the wasm module.</span></span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true"></a>        <span class="kw">let</span> array <span class="op">=</span> <span class="pp">js_sys::Array::</span>new()<span class="op">;</span></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true"></a>        array<span class="op">.</span>push(<span class="op">&amp;</span><span class="pp">wasm_bindgen::</span>module())<span class="op">;</span></span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true"></a>        array<span class="op">.</span>push(<span class="op">&amp;</span><span class="pp">wasm_bindgen::</span>memory())<span class="op">;</span></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true"></a>        worker<span class="op">.</span>post_message(<span class="op">&amp;</span>array)<span class="op">?;</span></span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true"></a></span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true"></a>        <span class="cn">Ok</span>(worker)</span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true"></a>    <span class="op">}</span></span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true"></a></span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true"></a>    <span class="co">/// Fetches a worker from this pool, spawning one if necessary.</span></span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true"></a>    <span class="co">/// This will attempt to pull an already-spawned web worker from our cache</span></span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true"></a>    <span class="co">/// if one is available, otherwise it will spawn a new worker and return the</span></span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true"></a>    <span class="co">/// newly spawned worker.</span></span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true"></a>    <span class="co">/// # Errors</span></span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true"></a>    <span class="co">/// Returns any error that may happen while a JS web worker is created and a</span></span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true"></a>    <span class="co">/// message is sent to it.</span></span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true"></a>    <span class="kw">fn</span> worker(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Worker<span class="op">,</span> JsValue<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true"></a>        <span class="kw">match</span> <span class="kw">self</span><span class="op">.</span>state<span class="op">.</span>workers<span class="op">.</span>borrow_mut()<span class="op">.</span>pop() <span class="op">{</span></span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true"></a>            <span class="cn">Some</span>(worker) <span class="op">=&gt;</span> <span class="cn">Ok</span>(worker)<span class="op">,</span></span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true"></a>            <span class="cn">None</span> <span class="op">=&gt;</span> <span class="kw">self</span><span class="op">.</span>spawn()<span class="op">,</span></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true"></a>        <span class="op">}</span></span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true"></a>    <span class="op">}</span></span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true"></a></span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true"></a>    <span class="co">/// Executes the work `f` in a web worker, spawning a web worker if</span></span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true"></a>    <span class="co">/// necessary.</span></span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true"></a>    <span class="co">/// This will acquire a web worker and then send the closure `f` to the</span></span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true"></a>    <span class="co">/// worker to execute. The worker won&#39;t be usable for anything else while</span></span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true"></a>    <span class="co">/// `f` is executing, and no callbacks are registered for when the worker</span></span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true"></a>    <span class="co">/// finishes.</span></span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true"></a>    <span class="co">/// # Errors</span></span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true"></a>    <span class="co">/// Returns any error that may happen while a JS web worker is created and a</span></span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true"></a>    <span class="co">/// message is sent to it.</span></span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true"></a>    <span class="kw">fn</span> execute(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> f<span class="op">:</span> <span class="kw">impl</span> <span class="bu">FnOnce</span>() <span class="op">+</span> <span class="bu">Send</span> <span class="op">+</span> <span class="ot">&#39;static</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Worker<span class="op">,</span> JsValue<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true"></a>        <span class="kw">let</span> worker <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>worker()<span class="op">?;</span></span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true"></a>        <span class="kw">let</span> work <span class="op">=</span> <span class="dt">Box</span><span class="pp">::</span>new(Work <span class="op">{</span> func<span class="op">:</span> <span class="dt">Box</span><span class="pp">::</span>new(f) <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true"></a>        <span class="kw">let</span> ptr <span class="op">=</span> <span class="dt">Box</span><span class="pp">::</span>into_raw(work)<span class="op">;</span></span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true"></a>        <span class="kw">match</span> worker<span class="op">.</span>post_message(<span class="op">&amp;</span><span class="pp">JsValue::</span>from(ptr <span class="kw">as</span> <span class="dt">u32</span>)) <span class="op">{</span></span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true"></a>            <span class="cn">Ok</span>(()) <span class="op">=&gt;</span> <span class="cn">Ok</span>(worker)<span class="op">,</span></span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true"></a>            <span class="cn">Err</span>(e) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true"></a>                <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true"></a>                    drop(<span class="dt">Box</span><span class="pp">::</span>from_raw(ptr))<span class="op">;</span></span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true"></a>                <span class="op">}</span></span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true"></a>                <span class="cn">Err</span>(e)</span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true"></a>            <span class="op">}</span></span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true"></a>        <span class="op">}</span></span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true"></a>    <span class="op">}</span></span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true"></a></span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true"></a>    <span class="co">/// Configures an `onmessage` callback for the `worker` specified for the</span></span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true"></a>    <span class="co">/// web worker to be reclaimed and re-inserted into this pool when a message</span></span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true"></a>    <span class="co">/// is received.</span></span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true"></a>    <span class="co">/// Currently this `WorkerPool` abstraction is intended to execute one-off</span></span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true"></a>    <span class="co">/// style work where the work itself doesn&#39;t send any notifications and</span></span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true"></a>    <span class="co">/// whatn it&#39;s done the worker is ready to execute more work. This method is</span></span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true"></a>    <span class="co">/// used for all spawned workers to ensure that when the work is finished</span></span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true"></a>    <span class="co">/// the worker is reclaimed back into this pool.</span></span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true"></a>    <span class="kw">fn</span> reclaim_on_message(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> worker<span class="op">:</span> Worker) <span class="op">{</span></span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true"></a>        <span class="kw">let</span> state <span class="op">=</span> <span class="pp">Rc::</span>downgrade(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>state)<span class="op">;</span></span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true"></a>        <span class="kw">let</span> worker2 <span class="op">=</span> worker<span class="op">.</span>clone()<span class="op">;</span></span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true"></a>        <span class="kw">let</span> reclaim_slot <span class="op">=</span> <span class="pp">Rc::</span>new(<span class="pp">RefCell::</span>new(<span class="cn">None</span>))<span class="op">;</span></span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true"></a>        <span class="kw">let</span> slot2 <span class="op">=</span> reclaim_slot<span class="op">.</span>clone()<span class="op">;</span></span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true"></a>        <span class="kw">let</span> reclaim <span class="op">=</span> <span class="pp">Closure::</span><span class="op">&lt;</span><span class="kw">dyn</span> <span class="bu">FnMut</span>(_)<span class="op">&gt;</span><span class="pp">::</span>new(<span class="kw">move</span> <span class="op">|</span>event<span class="op">:</span> Event<span class="op">|</span> <span class="op">{</span></span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true"></a>            <span class="kw">if</span> <span class="kw">let</span> <span class="cn">Some</span>(error) <span class="op">=</span> event<span class="op">.</span><span class="pp">dyn_ref::</span><span class="op">&lt;</span>ErrorEvent<span class="op">&gt;</span>() <span class="op">{</span></span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true"></a>                <span class="pp">console_log!</span>(<span class="st">&quot;error in worker: {}&quot;</span><span class="op">,</span> error<span class="op">.</span>message())<span class="op">;</span></span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true"></a>                <span class="co">// </span><span class="al">TODO</span><span class="co">: this probably leaks memory somehow? It&#39;s sort of</span></span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true"></a>                <span class="co">// unclear what to do about errors in workers right now.</span></span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true"></a>                <span class="kw">return</span><span class="op">;</span></span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true"></a>            <span class="op">}</span></span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true"></a></span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true"></a>            <span class="co">// If this is a completion event then can deallocate our own</span></span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true"></a>            <span class="co">// callback by clearing out `slot2` which contains our own closure.</span></span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true"></a>            <span class="kw">if</span> <span class="kw">let</span> <span class="cn">Some</span>(_msg) <span class="op">=</span> event<span class="op">.</span><span class="pp">dyn_ref::</span><span class="op">&lt;</span>MessageEvent<span class="op">&gt;</span>() <span class="op">{</span></span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true"></a>                <span class="kw">if</span> <span class="kw">let</span> <span class="cn">Some</span>(state) <span class="op">=</span> state<span class="op">.</span>upgrade() <span class="op">{</span></span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true"></a>                    state<span class="op">.</span>push(worker2<span class="op">.</span>clone())<span class="op">;</span></span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true"></a>                <span class="op">}</span></span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true"></a>                <span class="op">*</span>slot2<span class="op">.</span>borrow_mut() <span class="op">=</span> <span class="cn">None</span><span class="op">;</span></span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true"></a>                <span class="kw">return</span><span class="op">;</span></span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true"></a>            <span class="op">}</span></span>
<span id="cb7-165"><a href="#cb7-165" aria-hidden="true"></a></span>
<span id="cb7-166"><a href="#cb7-166" aria-hidden="true"></a>            <span class="pp">console_log!</span>(<span class="st">&quot;unhandled event: {}&quot;</span><span class="op">,</span> event<span class="op">.</span>type_())<span class="op">;</span></span>
<span id="cb7-167"><a href="#cb7-167" aria-hidden="true"></a>            <span class="kw">crate</span><span class="pp">::</span>logv(<span class="op">&amp;</span>event)<span class="op">;</span></span>
<span id="cb7-168"><a href="#cb7-168" aria-hidden="true"></a>            <span class="co">// </span><span class="al">TODO</span><span class="co">: like above, maybe a memory leak here?</span></span>
<span id="cb7-169"><a href="#cb7-169" aria-hidden="true"></a>        <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb7-170"><a href="#cb7-170" aria-hidden="true"></a>        worker<span class="op">.</span>set_onmessage(<span class="cn">Some</span>(reclaim<span class="op">.</span>as_ref()<span class="op">.</span>unchecked_ref()))<span class="op">;</span></span>
<span id="cb7-171"><a href="#cb7-171" aria-hidden="true"></a>        <span class="op">*</span>reclaim_slot<span class="op">.</span>borrow_mut() <span class="op">=</span> <span class="cn">Some</span>(reclaim)<span class="op">;</span></span>
<span id="cb7-172"><a href="#cb7-172" aria-hidden="true"></a>    <span class="op">}</span></span>
<span id="cb7-173"><a href="#cb7-173" aria-hidden="true"></a><span class="op">}</span></span>
<span id="cb7-174"><a href="#cb7-174" aria-hidden="true"></a></span>
<span id="cb7-175"><a href="#cb7-175" aria-hidden="true"></a><span class="kw">impl</span> WorkerPool <span class="op">{</span></span>
<span id="cb7-176"><a href="#cb7-176" aria-hidden="true"></a>    <span class="co">/// Executes `f` in a web worker.</span></span>
<span id="cb7-177"><a href="#cb7-177" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-178"><a href="#cb7-178" aria-hidden="true"></a>    <span class="co">/// This pool manages a set of web workers to draw from, and `f` will be</span></span>
<span id="cb7-179"><a href="#cb7-179" aria-hidden="true"></a>    <span class="co">/// spawned quickly into one if the worker is idle. If no idle workers are</span></span>
<span id="cb7-180"><a href="#cb7-180" aria-hidden="true"></a>    <span class="co">/// available then a new web worker will be spawned.</span></span>
<span id="cb7-181"><a href="#cb7-181" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-182"><a href="#cb7-182" aria-hidden="true"></a>    <span class="co">/// Once `f` returns the worker assigned to `f` is automatically reclaimed</span></span>
<span id="cb7-183"><a href="#cb7-183" aria-hidden="true"></a>    <span class="co">/// by this `WorkerPool`. This method provides no method of learning when</span></span>
<span id="cb7-184"><a href="#cb7-184" aria-hidden="true"></a>    <span class="co">/// `f` completes, and for that you&#39;ll need to use `run_notify`.</span></span>
<span id="cb7-185"><a href="#cb7-185" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-186"><a href="#cb7-186" aria-hidden="true"></a>    <span class="co">/// # Errors</span></span>
<span id="cb7-187"><a href="#cb7-187" aria-hidden="true"></a>    <span class="co">///</span></span>
<span id="cb7-188"><a href="#cb7-188" aria-hidden="true"></a>    <span class="co">/// If an error happens while spawning a web worker or sending a message to</span></span>
<span id="cb7-189"><a href="#cb7-189" aria-hidden="true"></a>    <span class="co">/// a web worker, that error is returned.</span></span>
<span id="cb7-190"><a href="#cb7-190" aria-hidden="true"></a>    <span class="kw">pub</span> <span class="kw">fn</span> run(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> f<span class="op">:</span> <span class="kw">impl</span> <span class="bu">FnOnce</span>() <span class="op">+</span> <span class="bu">Send</span> <span class="op">+</span> <span class="ot">&#39;static</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> JsValue<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb7-191"><a href="#cb7-191" aria-hidden="true"></a>        <span class="kw">let</span> worker <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>execute(f)<span class="op">?;</span></span>
<span id="cb7-192"><a href="#cb7-192" aria-hidden="true"></a>        <span class="kw">self</span><span class="op">.</span>reclaim_on_message(worker)<span class="op">;</span></span>
<span id="cb7-193"><a href="#cb7-193" aria-hidden="true"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb7-194"><a href="#cb7-194" aria-hidden="true"></a>    <span class="op">}</span></span>
<span id="cb7-195"><a href="#cb7-195" aria-hidden="true"></a><span class="op">}</span></span>
<span id="cb7-196"><a href="#cb7-196" aria-hidden="true"></a></span>
<span id="cb7-197"><a href="#cb7-197" aria-hidden="true"></a><span class="kw">impl</span> PoolState <span class="op">{</span></span>
<span id="cb7-198"><a href="#cb7-198" aria-hidden="true"></a>    <span class="kw">fn</span> push(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> worker<span class="op">:</span> Worker) <span class="op">{</span></span>
<span id="cb7-199"><a href="#cb7-199" aria-hidden="true"></a>        worker<span class="op">.</span>set_onmessage(<span class="cn">Some</span>(<span class="kw">self</span><span class="op">.</span>callback<span class="op">.</span>as_ref()<span class="op">.</span>unchecked_ref()))<span class="op">;</span></span>
<span id="cb7-200"><a href="#cb7-200" aria-hidden="true"></a>        worker<span class="op">.</span>set_onerror(<span class="cn">Some</span>(<span class="kw">self</span><span class="op">.</span>callback<span class="op">.</span>as_ref()<span class="op">.</span>unchecked_ref()))<span class="op">;</span></span>
<span id="cb7-201"><a href="#cb7-201" aria-hidden="true"></a>        <span class="kw">let</span> <span class="kw">mut</span> workers <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>workers<span class="op">.</span>borrow_mut()<span class="op">;</span></span>
<span id="cb7-202"><a href="#cb7-202" aria-hidden="true"></a>        <span class="kw">for</span> prev <span class="kw">in</span> workers<span class="op">.</span>iter() <span class="op">{</span></span>
<span id="cb7-203"><a href="#cb7-203" aria-hidden="true"></a>            <span class="kw">let</span> prev<span class="op">:</span> <span class="op">&amp;</span>JsValue <span class="op">=</span> prev<span class="op">;</span></span>
<span id="cb7-204"><a href="#cb7-204" aria-hidden="true"></a>            <span class="kw">let</span> worker<span class="op">:</span> <span class="op">&amp;</span>JsValue <span class="op">=</span> <span class="op">&amp;</span>worker<span class="op">;</span></span>
<span id="cb7-205"><a href="#cb7-205" aria-hidden="true"></a>            <span class="pp">assert!</span>(prev <span class="op">!=</span> worker)<span class="op">;</span></span>
<span id="cb7-206"><a href="#cb7-206" aria-hidden="true"></a>        <span class="op">}</span></span>
<span id="cb7-207"><a href="#cb7-207" aria-hidden="true"></a>        workers<span class="op">.</span>push(worker)<span class="op">;</span></span>
<span id="cb7-208"><a href="#cb7-208" aria-hidden="true"></a>    <span class="op">}</span></span>
<span id="cb7-209"><a href="#cb7-209" aria-hidden="true"></a><span class="op">}</span></span>
<span id="cb7-210"><a href="#cb7-210" aria-hidden="true"></a></span>
<span id="cb7-211"><a href="#cb7-211" aria-hidden="true"></a><span class="co">/// Entry point invoked by `worker.js`, a bit of a hack but see the &quot;TODO&quot; above</span></span>
<span id="cb7-212"><a href="#cb7-212" aria-hidden="true"></a><span class="co">/// about `worker.js` in general.</span></span>
<span id="cb7-213"><a href="#cb7-213" aria-hidden="true"></a><span class="at">#[</span>wasm_bindgen<span class="at">]</span></span>
<span id="cb7-214"><a href="#cb7-214" aria-hidden="true"></a><span class="kw">pub</span> <span class="kw">fn</span> child_entry_point(ptr<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> JsValue<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb7-215"><a href="#cb7-215" aria-hidden="true"></a>    <span class="kw">let</span> ptr <span class="op">=</span> <span class="kw">unsafe</span> <span class="op">{</span> <span class="dt">Box</span><span class="pp">::</span>from_raw(ptr <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> Work) <span class="op">};</span></span>
<span id="cb7-216"><a href="#cb7-216" aria-hidden="true"></a>    <span class="kw">let</span> global <span class="op">=</span> <span class="pp">js_sys::</span>global()<span class="op">.</span><span class="pp">unchecked_into::</span><span class="op">&lt;</span>DedicatedWorkerGlobalScope<span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb7-217"><a href="#cb7-217" aria-hidden="true"></a>    (ptr<span class="op">.</span>func)()<span class="op">;</span></span>
<span id="cb7-218"><a href="#cb7-218" aria-hidden="true"></a>    global<span class="op">.</span>post_message(<span class="op">&amp;</span><span class="pp">JsValue::</span>undefined())<span class="op">?;</span></span>
<span id="cb7-219"><a href="#cb7-219" aria-hidden="true"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb7-220"><a href="#cb7-220" aria-hidden="true"></a><span class="op">}</span></span></code></pre></div>
<h3 id="running-the-demo">Running the demo</h3>
<p>"<em>Currently it’s required to use the –target no-modules or –target web flag with wasm-bindgen to run threaded code. This is because the WebAssembly file imports memory instead of exporting it, so we need to hook initialization of the wasm module at this time to provide the appropriate memory object. This demo uses –target no-modules, because Firefox does not support modules in workers.</em></p>
<p><em>With –target no-modules you’ll be able to use importScripts inside of each web worker to import the shim JS generated by wasm-bindgen as well as calling the wasm_bindgen initialization function with the shared memory instance from the main thread. The expected usage is that WebAssembly on the main thread will post its memory object to all other threads to get instantiated with.</em>"<br />
_ <a href="https://rustwasm.github.io/wasm-bindgen/examples/raytrace-parallel.html" target="_blank">wasm-bindgen Guide</a></p>
<h2 id="build-and-serve">build and serve</h2>
<blockquote>
<p>This example requires to <em>not</em> create ES modules, therefore we pass the flag <code>--target no-modules</code></p>
</blockquote>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="ex">wasm-pack</span> build --target no-modules --no-typescript --out-dir www/pkg</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a><span class="ex">http</span> www</span></code></pre></div>
<p>open <code>index.html</code></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="ex">firefox</span> http://localhost:8000/html/</span></code></pre></div>
<hr />
<h2 id="whats-next">What’s next?</h2>
<p>Next example: <a href="./021.wasm-audio-worklet.html">Wasm audio worklet <code>--&gt;</code></a></p>
</main>
<script src="https://lerina.github.io/js/toc.js"></script>
<script>
let anchor= document.createElement('a');
anchor.href="javascript:closeNav()"; //void(0)"; //anchor[0].onclick = closeNav();
anchor.className = "closebtn";  
anchor.innerHTML="&times;";
document.getElementById("TOC").prepend(anchor);

let navCrumbs= document.createElement('div');
navCrumbs.className = "hover-nav";
navCrumbs.innerHTML = `
<div class="hover-nav">
<ul>
<li><a href="../../../../index.html">⇦ home</a></li>
<li><a href="../index.html">hello_world</a></li>
</ul>
</div>`;
document.getElementById("TOC").prepend(navCrumbs); 
</script>
</body>
</html>
